const { json } = require('body-parser')
const { generateRoutes } = require('herbs2rest')
const cors = require('cors')
const express = require('express')
const renderShelfHTML = require('herbsshelf')
const usecases = require('../../../domain/usecases')

const controllers = []

module.exports = (app, config) => {
    app.use(json({limit: '50mb'}))
    app.use(cors())

    const routes = new express.Router()

    const verbose = !config.isProd
    generateRoutes(controllers, routes, verbose)
    app.use(routes)

    const promises = usecases.map(uc => {
        uc.usecase = uc.usecase({})
        return uc
    })
    Promise.all(promises).then(usecases => {
        const shelf = renderShelfHTML(usecases)
        app.get('/herbsshelf', (_, res) => {
            res.setHeader('Content-Type', 'text/html')
            res.write(shelf)
            res.end()
        })
    })

}